{% extends "base.html" %}
{% block content %}
<h4>Create Invoice (Scan + Multi Products)</h4>

<div class="row g-3">
  <div class="col-md-5">
    <div class="card p-3">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" id="startScanBtn">Scan Barcode</button>
        <button class="btn btn-outline-secondary" id="stopScanBtn">Stop</button>
      </div>
      <video id="preview" class="w-100 mt-3" style="border-radius:12px;"></video>

      <div class="mt-3">
        <label class="form-label">Location</label>
        <select id="locationSelect" class="form-select">
          {% for loc in locations %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mt-2">
        <label class="form-label">Customer</label>
        <select id="customerSelect" class="form-select">
          <option value="">Walk-in</option>
          {% for c in customers %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mt-2">
        <input id="walkinName" class="form-control" placeholder="Walk-in name (optional)">
      </div>

      <button class="btn btn-success mt-3" id="checkoutBtn">Checkout & Generate Invoice</button>
      <div class="mt-2 small" id="msg"></div>
    </div>
  </div>

  <div class="col-md-7">
    <div class="card p-3">
      <h6>Cart</h6>
      <table class="table table-sm" id="cartTable">
        <thead><tr><th>SKU</th><th>Name</th><th>Qty</th><th>Price</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="/static/inventory/scanner.js"></script>
<script src="/static/inventory/app.js"></script>
<script>
  const cart = new Map(); // sku -> {sku, name, qty, unit_price}

  function renderCart(){
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = "";
    for(const item of cart.values()){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.sku}</td>
        <td>${item.name}</td>
        <td><input type="number" min="1" value="${item.qty}" data-sku="${item.sku}" class="form-control form-control-sm qtyInput"></td>
        <td>${item.unit_price}</td>
        <td><button class="btn btn-sm btn-outline-danger removeBtn" data-sku="${item.sku}">x</button></td>
      `;
      tbody.appendChild(tr);
    }
  }

  document.addEventListener("input", (e)=>{
    if(e.target.classList.contains("qtyInput")){
      const sku = e.target.getAttribute("data-sku");
      const qty = parseInt(e.target.value || "1", 10);
      const item = cart.get(sku);
      item.qty = qty;
      cart.set(sku, item);
    }
  });

  document.addEventListener("click", (e)=>{
    if(e.target.classList.contains("removeBtn")){
      cart.delete(e.target.getAttribute("data-sku"));
      renderCart();
    }
  });

  async function addByCode(code){
    const res = await fetch(`/api/scan/?code=${encodeURIComponent(code)}`);
    if(!res.ok){
      // treat as sku
      return addBySku(code);
    }
    const p = await res.json();
    return addBySku(p.sku);
  }

  async function addBySku(sku){
    // fetch product list? direct scan api already maps; simplest: use scan api with sku fallback
    const res = await fetch(`/api/scan/?code=${encodeURIComponent(sku)}`);
    if(!res.ok){
      document.getElementById("msg").innerText = "Product not found: " + sku;
      return;
    }
    const p = await res.json();
    const existing = cart.get(p.sku);
    if(existing){
      existing.qty += 1;
      cart.set(p.sku, existing);
    } else {
      cart.set(p.sku, {sku: p.sku, name: p.product_name, qty: 1, unit_price: p.selling_price});
    }
    renderCart();
    document.getElementById("msg").innerText = "Added: " + p.sku;
  }

  window.InventoryScanner.attach({
    videoId: "preview",
    startBtnId: "startScanBtn",
    stopBtnId: "stopScanBtn",
    onCode: addByCode
  });

  document.getElementById("checkoutBtn").addEventListener("click", async ()=>{
    if(cart.size === 0){
      document.getElementById("msg").innerText = "Cart empty";
      return;
    }
    const payload = {
      location_id: parseInt(document.getElementById("locationSelect").value, 10),
      customer_id: document.getElementById("customerSelect").value ? parseInt(document.getElementById("customerSelect").value, 10) : undefined,
      customer_name_fallback: document.getElementById("walkinName").value || "",
      lines: Array.from(cart.values()).map(x => ({sku: x.sku, qty: x.qty, unit_price: x.unit_price}))
    };
    const res = await fetch("/api/invoices/create/", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(res.ok){
      window.location.href = `/invoice/${data.invoice_no}/`;
    } else {
      document.getElementById("msg").innerText = data.detail || "Error creating invoice";
    }
  });
</script>
{% endblock %}
